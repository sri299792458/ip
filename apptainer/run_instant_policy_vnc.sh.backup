#!/bin/bash
#
# Run Instant Policy container with VNC on MSI cluster
#
# Usage: ./run_instant_policy_vnc.sh [command]
# Example: ./run_instant_policy_vnc.sh python eval.py --task_name=plate_out --num_demos=2
#

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="${PROJECT_DIR:-$HOME/ips}"
INSTANT_POLICY_DIR="${INSTANT_POLICY_DIR:-$PROJECT_DIR/instant_policy}"
DATA_DIR="${DATA_DIR:-/scratch.global/$USER/ips}"
CONTAINER_IMAGE="$SCRIPT_DIR/instant_policy.sif"
DISPLAY_NUM="${RLBENCH_DISPLAY:-1}"
VNC_PORT="${RLBENCH_VNC_PORT:-5900}"

# Validation
[ ! -f "$CONTAINER_IMAGE" ] && echo "ERROR: Container not found: $CONTAINER_IMAGE" && exit 1
[ ! -d "$INSTANT_POLICY_DIR" ] && echo "ERROR: instant_policy not found: $INSTANT_POLICY_DIR" && exit 1

mkdir -p "$DATA_DIR/checkpoints"

# NVIDIA library bindings (Rocky Linux -> Ubuntu)
NVIDIA_LIB_DIR="/usr/lib64"
[ ! -d "$NVIDIA_LIB_DIR" ] && NVIDIA_LIB_DIR="/usr/lib/x86_64-linux-gnu"

BIND_LIBS=""
for lib in libGLX_nvidia.so libEGL_nvidia.so libnvidia-glcore.so libnvidia-tls.so \
           libnvidia-glsi.so libGLdispatch.so libOpenGL.so libGLX.so libEGL.so; do
    found=$(find $NVIDIA_LIB_DIR -name "${lib}*" 2>/dev/null | head -1)
    [ -n "$found" ] && BIND_LIBS="$BIND_LIBS --bind $found:/usr/lib/x86_64-linux-gnu/$(basename $found)"
done
[ -d "/usr/share/vulkan/icd.d" ] && BIND_LIBS="$BIND_LIBS --bind /usr/share/vulkan/icd.d:/usr/share/vulkan/icd.d"

# Cleanup stale processes
for pattern in "Xvfb :$DISPLAY_NUM" "x11vnc.*-rfbport $VNC_PORT" "fluxbox"; do
    pid=$(ps -u "$USER" -o pid= -o args= 2>/dev/null | awk "/$pattern/{print \$1; exit}")
    [ -n "$pid" ] && kill -9 "$pid" 2>/dev/null || true
done
rm -f "/tmp/.X${DISPLAY_NUM}-lock" "/tmp/.X11-unix/X${DISPLAY_NUM}"

echo "==================================="
echo "Instant Policy + VNC"
echo "Node: $(hostname)"
echo "VNC: ssh -L $VNC_PORT:$(hostname):$VNC_PORT $USER@agate.msi.umn.edu"
echo "==================================="

CMD="${@:-bash}"

# Run container
# --no-home: prevents ~/.local/ conflicts with container packages
apptainer exec --nv --no-home \
    $BIND_LIBS \
    --bind "$INSTANT_POLICY_DIR:/workspace/instant_policy" \
    --bind "$DATA_DIR:/workspace/data" \
    --pwd /workspace/instant_policy/ip \
    "$CONTAINER_IMAGE" \
    bash -c "
        # Redirect cache directories to writable location (--no-home makes home read-only)
        export HOME=/workspace/data
        export XDG_CACHE_HOME=/workspace/data/.cache
        export TRANSFORMERS_CACHE=/workspace/data/.cache/huggingface
        export HF_HOME=/workspace/data/.cache/huggingface
        export MPLCONFIGDIR=/workspace/data/.cache/matplotlib
        mkdir -p /workspace/data/.cache/huggingface /workspace/data/.cache/matplotlib /workspace/data/.fluxbox

        # VNC setup
        export DISPLAY=:$DISPLAY_NUM
        Xvfb :$DISPLAY_NUM -screen 0 1280x1024x24 &
        sleep 2
        x11vnc -display :$DISPLAY_NUM -forever -nopw -rfbport $VNC_PORT -noxdamage -nowf &
        sleep 1
        fluxbox &
        sleep 1

        echo 'VNC ready on port $VNC_PORT'
        nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null || echo 'WARNING: No GPU'

        # CoppeliaSim writable copy (container's /opt is read-only)
        if [ ! -d /workspace/data/.coppeliasim ]; then
            echo 'Copying CoppeliaSim to writable location...'
            cp -r /opt/CoppeliaSim /workspace/data/.coppeliasim

            # Disable GUI plugins that cause segfault in headless VNC
            echo 'Disabling GUI plugins...'
            for plugin in libsimExtCustomUI.so libsimExtCodeEditor.so; do
                echo \"Checking for /workspace/data/.coppeliasim/\$plugin\"
                if [ -f /workspace/data/.coppeliasim/\$plugin ]; then
                    echo \"Found \$plugin, disabling...\"
                    mv /workspace/data/.coppeliasim/\$plugin /workspace/data/.coppeliasim/\$plugin.disabled
                    echo \"Disabled \$plugin\"
                else
                    echo \"WARNING: \$plugin not found\"
                fi
            done
            echo 'Plugin disabling complete'
        else
            echo 'CoppeliaSim already exists at /workspace/data/.coppeliasim'
        fi

        export COPPELIASIM_ROOT=/workspace/data/.coppeliasim
        export LD_LIBRARY_PATH=\$COPPELIASIM_ROOT:\$LD_LIBRARY_PATH
        export QT_QPA_PLATFORM_PLUGIN_PATH=\$COPPELIASIM_ROOT

        # Qt and OpenGL fixes
        export QT_DEBUG_PLUGINS=0
        export XDG_RUNTIME_DIR=/tmp/runtime-\$\$
        mkdir -p \$XDG_RUNTIME_DIR

        # Force software rendering for Bullet physics (no GPU acceleration for physics)
        export MESA_GL_VERSION_OVERRIDE=3.3
        export LIBGL_ALWAYS_SOFTWARE=1

        # instant_policy from host
        export PYTHONPATH=/workspace/instant_policy:\$PYTHONPATH

        # Checkpoints symlink
        [ -d /workspace/instant_policy/ip/checkpoints ] && [ ! -L /workspace/instant_policy/ip/checkpoints ] && rm -rf /workspace/instant_policy/ip/checkpoints
        [ ! -e /workspace/instant_policy/ip/checkpoints ] && ln -sf /workspace/data/checkpoints /workspace/instant_policy/ip/checkpoints

        cd /workspace/instant_policy/ip
        $CMD
    "

echo "Container exited"
