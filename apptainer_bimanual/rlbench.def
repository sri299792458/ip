Bootstrap: docker
From: nvidia/cuda:12.1.1-devel-ubuntu20.04

%labels
    Author sri299792458
    Description CoppeliaSim + PyRep + RLBench for bimanual evaluation on UMN MSI

%environment
    # CoppeliaSim
    export COPPELIASIM_ROOT=/opt/CoppeliaSim
    export LD_LIBRARY_PATH=$COPPELIASIM_ROOT:$LD_LIBRARY_PATH
    export QT_QPA_PLATFORM_PLUGIN_PATH=$COPPELIASIM_ROOT
    
    # Display for VNC
    export DISPLAY=:1
    
    # Python
    export PATH=/opt/conda/envs/ip/bin:/opt/conda/bin:$PATH

%post
    # Prevent interactive prompts
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/Chicago
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    
    # ============================================
    # System dependencies
    # ============================================
    apt-get update && apt-get install -y \
        wget curl git unzip \
        xvfb x11vnc fluxbox \
        libgl1-mesa-glx libgl1-mesa-dri \
        libxcb-xinerama0 libxkbcommon-x11-0 \
        libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
        libxcb-randr0 libxcb-render-util0 libxcb-shape0 \
        libxcb-xfixes0 libxcb-sync1 \
        python3-dev python3-pip \
        libavcodec-dev libavformat-dev libswscale-dev \
        && rm -rf /var/lib/apt/lists/*
    
    # ============================================
    # Miniforge (conda-forge only, no Anaconda TOS prompt)
    # ============================================
    wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh -O /tmp/miniforge.sh
    bash /tmp/miniforge.sh -b -p /opt/conda
    rm /tmp/miniforge.sh
    export PATH=/opt/conda/bin:$PATH
    
    # Pin Python version to match Torch wheels
    /opt/conda/bin/conda create -y -n ip python=3.10 pip
    export PATH=/opt/conda/envs/ip/bin:/opt/conda/bin:$PATH
    
    # ============================================
    # CoppeliaSim V4.1.0 (required by PyRep)
    # ============================================
    cd /opt
    wget https://www.coppeliarobotics.com/files/V4_1_0/CoppeliaSim_Edu_V4_1_0_Ubuntu20_04.tar.xz
    tar -xf CoppeliaSim_Edu_V4_1_0_Ubuntu20_04.tar.xz
    mv CoppeliaSim_Edu_V4_1_0_Ubuntu20_04 CoppeliaSim
    rm CoppeliaSim_Edu_V4_1_0_Ubuntu20_04.tar.xz
    
    # Set environment for build
    export COPPELIASIM_ROOT=/opt/CoppeliaSim
    export LD_LIBRARY_PATH=$COPPELIASIM_ROOT:$LD_LIBRARY_PATH
    export QT_QPA_PLATFORM_PLUGIN_PATH=$COPPELIASIM_ROOT
    
    # ============================================
    # Python dependencies
    # ============================================
    pip install --upgrade pip
    pip install torch==2.2.0 torchvision==0.17.0 --index-url https://download.pytorch.org/whl/cu121
    pip install torch-geometric==2.7.0
    pip install torch_cluster==1.6.3+pt22cu121 torch_scatter==2.1.2+pt22cu121 \
        torch_sparse==0.6.18+pt22cu121 torch_spline_conv==1.2.2+pt22cu121 \
        -f https://data.pyg.org/whl/torch-2.2.0+cu121.html
    cat > /tmp/requirements_ip_full.txt << 'EOF'
addict==2.4.0
aiohappyeyeballs==2.6.1
aiohttp==3.13.2
aiosignal==1.4.0
annotated-types==0.7.0
anyio==4.12.0
asttokens==3.0.1
async-timeout==5.0.1
attrs==25.4.0
blinker==1.9.0
certifi==2025.11.12
charset-normalizer==3.4.4
click==8.3.1
comm==0.2.3
ConfigArgParse==1.7.1
contourpy==1.3.2
cycler==0.12.1
dash==3.3.0
debugpy==1.8.18
decorator==5.2.1
diffusers==0.27.2
exceptiongroup==1.3.1
executing==2.2.1
fastjsonschema==2.21.2
filelock==3.20.0
Flask==3.1.2
fonttools==4.61.0
frozenlist==1.8.0
fsspec==2025.12.0
gitdb==4.0.12
GitPython==3.1.45
h11==0.16.0
hf-xet==1.2.0
httpcore==1.0.9
httpx==0.28.1
huggingface-hub==0.23.0
idna==3.11
importlib_metadata==8.7.0
ipykernel==7.1.0
ipython==8.37.0
ipywidgets==8.1.8
itsdangerous==2.2.0
jedi==0.19.2
Jinja2==3.1.6
joblib==1.5.2
jsonschema==4.25.1
jsonschema-specifications==2025.9.1
jupyter_client==8.7.0
jupyter_core==5.9.1
jupyterlab_widgets==3.0.16
kiwisolver==1.4.9
lightning==2.6.0
lightning-utilities==0.15.2
MarkupSafe==3.0.3
matplotlib==3.10.8
matplotlib-inline==0.2.1
mpmath==1.3.0
multidict==6.7.0
narwhals==2.13.0
natsort==8.4.0
nbformat==5.10.4
nest-asyncio==1.6.0
networkx==3.4.2
numpy==1.26.4
nvidia-cublas-cu12==12.1.3.1
nvidia-cuda-cupti-cu12==12.1.105
nvidia-cuda-nvrtc-cu12==12.1.105
nvidia-cuda-runtime-cu12==12.1.105
nvidia-cudnn-cu12==8.9.2.26
nvidia-cufft-cu12==11.0.2.54
nvidia-curand-cu12==10.3.2.106
nvidia-cusolver-cu12==11.4.5.107
nvidia-cusparse-cu12==12.1.0.106
nvidia-nccl-cu12==2.19.3
nvidia-nvjitlink-cu12==12.9.86
nvidia-nvtx-cu12==12.1.105
open3d==0.18.0
packaging==25.0
pandas==2.3.3
parso==0.8.5
pexpect==4.9.0
pillow==12.0.0
pip==25.3
platformdirs==4.5.1
plotly==6.5.0
prompt_toolkit==3.0.52
propcache==0.4.1
protobuf==6.33.2
psutil==7.1.3
ptyprocess==0.7.0
pure_eval==0.2.3
pydantic==2.12.5
pydantic_core==2.41.5
Pygments==2.19.2
pyparsing==3.2.5
pyquaternion==0.9.9
python-dateutil==2.9.0.post0
pytorch-lightning==2.6.0
pytz==2025.2
PyYAML==6.0.3
pyzmq==27.1.0
referencing==0.37.0
regex==2025.11.3
requests==2.32.5
retrying==1.4.2
rpds-py==0.30.0
safetensors==0.7.0
scikit-learn==1.7.2
scipy==1.15.3
sentry-sdk==2.47.0
setuptools==80.9.0
shellingham==1.5.4
six==1.17.0
smmap==5.0.2
stack-data==0.6.3
sympy==1.14.0
threadpoolctl==3.6.0
torchmetrics==1.8.2
tornado==6.5.2
tqdm==4.67.1
traitlets==5.14.3
triton==2.2.0
typer-slim==0.20.0
typing_extensions==4.15.0
typing-inspection==0.4.2
tzdata==2025.2
urllib3==2.6.1
wandb==0.23.1
wcwidth==0.2.14
Werkzeug==3.1.4
wheel==0.45.1
widgetsnbextension==4.0.15
xxhash==3.6.0
yarl==1.22.0
zipp==3.23.0
EOF
    pip install -r /tmp/requirements_ip_full.txt
    rm /tmp/requirements_ip_full.txt
    
    # ============================================
    # PyRep (will be bound from host at runtime)
    # ============================================
    # PyRep requires COPPELIASIM_ROOT to be set during build
    # We'll install it at runtime from the bound directory
    
    # ============================================
    # Cleanup
    # ============================================
    apt-get clean
    pip cache purge

%runscript
    # Start Xvfb (virtual framebuffer)
    Xvfb :1 -screen 0 1280x1024x24 &
    sleep 2
    
    # Start VNC server
    x11vnc -display :1 -forever -nopw -rfbport 5900 &
    sleep 1
    
    # Start window manager
    fluxbox &
    sleep 1
    
    echo "==================================="
    echo "VNC server running on port 5900"
    echo "Connect via: ssh -L 5900:<node>:5900 user@agate.msi.umn.edu"
    echo "Then open VNC viewer to localhost:5900"
    echo "==================================="
    
    exec "$@"
